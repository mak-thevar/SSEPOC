@model IEnumerable<SseDemo.Domain.Entities.Feed>

@{
    ViewData["Title"] = "Live Feed";
}

<h1>Live Feed</h1>

<p>New feed items will appear at the top of the list automatically.</p>

<div id="feedContainer">
    @foreach (var feed in Model)
    {
        <div class="card mb-3">
            <div class="card-body shadow-sm rounded-3">
                <h5 class="card-title">@feed.Title</h5>
                <p class="card-text">@feed.Content</p>
                <p class="card-text"><small class="text-muted">@feed.Timestamp.ToString("F")</small></p>
            </div>
        </div>
    }
</div>


@section Scripts {
    <script>
        $(document).ready(function () {
            const eventSource = new EventSource("/Sse/Stream");

            eventSource.onmessage = function (event) {
                const feed = JSON.parse(event.data);

                const newFeedHtml = `
                    <div class="card mb-3 shadow-sm rounded-3" style="background-color: #d4edda; display: none;">
                        <div class="card-body">
                            <h5 class="card-title">${feed.title}</h5>
                            <p class="card-text">${feed.content}</p>
                            <p class="card-text"><small class="text-muted">${new Date(feed.timestamp).toLocaleString()}</small></p>
                        </div>
                    </div>`;

                const newFeedElement = $(newFeedHtml);
                $("#feedContainer").prepend(newFeedElement);
                newFeedElement.slideDown(500).animate({ backgroundColor: "#ffffff" }, 4000);
            };

            eventSource.onerror = function (err) {
                console.error("EventSource failed:", err);
                eventSource.close();
            };
        });
    </script>
}